ISTRUZIONI MANUALI DEFINITIVE (CORRETTE E COMPLETE)

1. Vai sul sito: https://supabase.com/dashboard/project/vpgzwgsagywasrxcracc/sql
2. Clicca su "New query" (in alto a sinistra).
3. Copia e incolla tutto il codice qui sotto.
4. Clicca "Run" (in basso a destra).

--- CODICE DA COPIARE ---

-- 1. CREAZIONE BUCKET PER CARICAMENTO IMMAGINI
INSERT INTO storage.buckets (id, name, public)
VALUES 
  ('gallery', 'gallery', true),
  ('products', 'products', true),
  ('staff', 'staff', true)
ON CONFLICT (id) DO UPDATE SET public = true;

-- 2. PERMESSI STORAGE (RLS)
DROP POLICY IF EXISTS "Public Access" ON storage.objects;
CREATE POLICY "Public Access"
ON storage.objects FOR ALL
USING ( bucket_id IN ('gallery', 'products', 'staff') )
WITH CHECK ( bucket_id IN ('gallery', 'products', 'staff') );

-- 3. INIZIALIZZAZIONE TABELLE
create extension if not exists "pgcrypto";

create table if not exists services (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  description text,
  price numeric not null,
  category text,
  is_active boolean default true,
  sort_order integer default 0
);

create table if not exists bookings (
  id uuid default gen_random_uuid() primary key,
  customer_name text not null,
  customer_phone text not null,
  customer_email text,
  service_id uuid references services(id),
  location text not null,
  booking_date date not null,
  booking_time time not null,
  status text not null default 'pending',
  notes text,
  created_at timestamp with time zone default now()
);

create table if not exists gallery (
  id uuid default gen_random_uuid() primary key,
  title text,
  media_url text not null,
  media_type text not null,
  is_active boolean default true,
  sort_order integer default 0
);

create table if not exists staff (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  role text,
  avatar_url text,
  is_active boolean default true
);

create table if not exists products (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  description text,
  price numeric not null,
  stock integer default 0,
  discount numeric default 0,
  image_url text,
  category text,
  is_active boolean default true
);

create table if not exists settings (
  id uuid default gen_random_uuid() primary key,
  is_shop_open boolean default true,
  announcement text
);

-- 4. PERMESSI UNIVERSALI (RLS)
ALTER TABLE services ENABLE ROW LEVEL SECURITY;
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;
ALTER TABLE gallery ENABLE ROW LEVEL SECURITY;
ALTER TABLE staff ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE reviews ENABLE ROW LEVEL SECURITY;

DO $$
DECLARE
    t text;
BEGIN
    FOR t IN SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' 
    LOOP
        EXECUTE format('DROP POLICY IF EXISTS "Universal Access" ON public.%I', t);
        EXECUTE format('CREATE POLICY "Universal Access" ON public.%I FOR ALL USING (true) WITH CHECK (true)', t);
    END LOOP;
END $$;

-- 5. DATI DI DEFAULT
INSERT INTO public.services (name, description, price, category, is_active, sort_order)
VALUES 
  ('Taglio Capelli', 'Taglio classico o moderno', 20, 'Capelli', true, 1),
  ('Taglio Barba', 'Regolazione barba con panno caldo', 15, 'Barba', true, 2)
ON CONFLICT DO NOTHING;

INSERT INTO settings (is_shop_open, announcement) 
SELECT true, 'Benvenuti'
WHERE NOT EXISTS (SELECT 1 FROM settings);
